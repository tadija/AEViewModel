/**
 *  https://github.com/tadija/AEViewModel
 *  Copyright © 2017-2020 Marko Tadić
 *  Licensed under the MIT license
 */

import UIKit
import AEViewModel

final class FormTVC: TableViewController, UITextFieldDelegate {

    typealias Id = FormDataSource.Id

    // MARK: Propertis

    private var username = String()

    // MARK: Lifecycle

    override func viewDidLoad() {
        super.viewDidLoad()
        dataSource = FormDataSource()
    }

    // MARK: Override

    override func cellType(forIdentifier identifier: String) -> TableCellType {
        switch identifier {
        case Id.username, Id.password:
            return .textField
        case Id.accept:
            return .toggle
        case Id.register:
            return .button
        default:
            fatalError("Identifier not supported.")
        }
    }

    override func update(_ cell: TableCell, at indexPath: IndexPath) {
        super.update(cell, at: indexPath)

        let id = dataSource.identifier(at: indexPath)
        switch id {
        case Id.username:
            (cell as? TableCellTextField)?.textField.delegate = self
        case Id.password:
            let textInputCell = (cell as? TableCellTextField)
            textInputCell?.textField.delegate = self
            textInputCell?.textField.isSecureTextEntry = true
        case Id.register:
            (cell as? TableCellButton)?.button.isEnabled = false
        default:
            break
        }
    }

    override func action(for cell: TableCell, at indexPath: IndexPath, sender: Any) {
        let id = dataSource.identifier(at: indexPath)
        switch id {
        case Id.username:
            if let textField = sender as? UITextField {
                username = textField.text ?? String()
            }
        case Id.accept:
            let toggle = (cell as? TableCellToggle)?.toggle
            didToggleAcceptCell(at: indexPath, sender: toggle)
        case Id.register:
            presentAlert()
        default:
            break
        }
    }

    // MARK: UITextFieldDelegate

    func textFieldShouldReturn(_ textField: UITextField) -> Bool {
        textField.resignFirstResponder()

        guard
            let cell = textField.superview?.superview as? UITableViewCell,
            let indexPath = tableView.indexPath(for: cell),
            dataSource.identifier(at: indexPath) == Id.username
        else {
            return false
        }

        let nextIndexPath = indexPath.next(in: tableView)
        becomeFirstResponder(at: nextIndexPath)

        return true
    }

    // MARK: Helpers

    @objc
    private func didToggleAcceptCell(at indexPath: IndexPath, sender: UISwitch?) {
        let enabled = sender?.isOn ?? false
        let nextIndexPath = indexPath.next(in: tableView)
        updateButton(at: nextIndexPath, enabled: enabled)
    }

    private func becomeFirstResponder(at indexPath: IndexPath?) {
        if let indexPath = indexPath,
            let cell = tableView.cellForRow(at: indexPath) as? TableCellTextField {
            cell.textField.becomeFirstResponder()
        }
    }

    private func updateButton(at indexPath: IndexPath?, enabled: Bool) {
        if let indexPath = indexPath,
            let cell = tableView.cellForRow(at: indexPath) as? TableCellButton {
            cell.button.isEnabled = enabled
        }
    }

    private func presentAlert() {
        let alert = UIAlertController(title: "Thank you \(username)",
                                      message: "Nice to have you onboard!",
                                      preferredStyle: .alert)
        let action = UIAlertAction(title: "OK", style: .default, handler: nil)
        alert.addAction(action)
        present(alert, animated: true, completion: nil)
    }

}
